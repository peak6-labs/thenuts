<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talk the Talk - Learn Poker Lingo</title>
    <script src="cards.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 100%;
            padding: 30px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .menu-screen {
            display: block;
        }

        .game-screen {
            display: none;
        }

        .game-selector {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 30px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .game-button {
            padding: 25px;
            border: 2px solid #ddd;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .game-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .game-button h3 {
            font-size: 1.5em;
            margin-bottom: 8px;
            color: #333;
        }

        .game-button p {
            font-size: 1em;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .game-button .progress-text {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .game-button .high-score {
            font-size: 1.1em;
            font-weight: bold;
            color: #667eea;
        }

        .game-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 10px 0;
            border-bottom: 2px solid #eee;
        }

        .menu-button {
            padding: 10px 20px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .menu-button:hover {
            background: #e0e0e0;
            transform: translateX(-5px);
        }

        #currentGameTitle {
            font-size: 1.5em;
            color: #333;
            margin: 0;
        }

        .game-area {
            min-height: 400px;
            display: none;
        }

        .game-area.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Card styles now provided by cards.js library */
        .card {
            display: inline-block;
            line-height: 100px;
            cursor: pointer;
        }

        .card-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
            gap: 10px;
        }

        .choices-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .choice-button {
            padding: 15px 20px;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: white;
            color: #667eea;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .choice-button:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }

        .choice-button.correct {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .choice-button.incorrect {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .choice-button:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .score-display {
            text-align: center;
            font-size: 1.2em;
            margin: 20px 0;
            color: #333;
        }

        .feedback {
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            text-align: center;
            font-size: 1.1em;
            display: none;
        }

        .feedback.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .results-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .results-modal.show {
            display: flex;
        }

        .results-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            text-align: center;
            animation: slideIn 0.5s ease-out;
        }

        .results-content h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .results-content .score {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
        }

        .results-content button {
            padding: 15px 30px;
            margin: 10px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .results-content .play-again {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .results-content .back-to-menu {
            background: #f0f0f0;
            color: #333;
        }

        .results-content button:hover {
            transform: scale(1.05);
        }

        .hand-comparison {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 30px 0;
            flex-wrap: wrap;
            gap: 30px;
        }

        .hand-side {
            text-align: center;
        }

        .hand-side h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.3em;
        }

        .vs-text {
            font-size: 2em;
            font-weight: bold;
            color: #666;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            /* Mobile card sizing handled by cards.js */
            
            .game-button {
                min-width: 150px;
            }
            
            .hand-comparison {
                flex-direction: column;
            }
            
            .vs-text {
                margin: 20px 0;
            }
        }

        .instructions {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #666;
            text-align: center;
            font-size: 1.1em;
        }

        .seven-card-display {
            margin: 30px 0;
        }

        .seven-card-display h4 {
            text-align: center;
            color: #666;
            margin-bottom: 10px;
        }

        .community-cards, .hole-cards {
            display: flex;
            justify-content: center;
            margin: 15px 0;
            gap: 10px;
        }

        .divider {
            text-align: center;
            color: #999;
            margin: 10px 0;
            font-size: 0.9em;
        }

        .selected-hand {
            border: 3px solid #667eea;
            background: #f0f3ff;
            border-radius: 10px;
            padding: 10px;
            margin: 20px auto;
            max-width: 400px;
        }

        .selected-hand h4 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
        }

        .submit-button {
            display: block;
            margin: 20px auto;
            padding: 15px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-button:hover:not(:disabled) {
            transform: scale(1.05);
        }

        .submit-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Main Menu -->
        <div class="menu-screen" id="menuScreen">
            <div class="header">
                <button class="menu-button" onclick="window.location.href='index.html'">← Main Menu</button>
                <h1>Talk the Talk</h1>
                <p>Learn the basic foundational lingo of poker</p>
            </div>

            <div class="game-selector">
                <div class="game-button" onclick="startGame('nameHand')" id="nameHandBtn">
                    <h3>Name That Hand</h3>
                    <p>Identify hand types</p>
                    <div class="progress-text">30 rounds</div>
                    <div class="high-score" id="nameHandHighScore">Best: 0/30</div>
                </div>
                <div class="game-button" onclick="startGame('bestFive')" id="bestFiveBtn">
                    <h3>Best Five</h3>
                    <p>Select optimal cards</p>
                    <div class="progress-text">10 rounds</div>
                    <div class="high-score" id="bestFiveHighScore">Best: 0/10</div>
                </div>
                <div class="game-button" onclick="startGame('handVsHand')" id="handVsHandBtn">
                    <h3>Hand vs Hand</h3>
                    <p>Compare two hands</p>
                    <div class="progress-text">10 rounds</div>
                    <div class="high-score" id="handVsHandHighScore">Best: 0/10</div>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div class="game-screen" id="gameScreen" style="display: none;">
            <div class="game-header">
                <button class="menu-button" onclick="returnToMenu()">← Menu</button>
                <h2 id="currentGameTitle">Name That Hand</h2>
            </div>

        <!-- Name That Hand Game -->
        <div class="game-area active" id="nameHandGame">
            <div class="instructions">
                Look at the 5 cards below and identify what poker hand they make
            </div>
            <div class="score-display">
                Round <span id="nameHandRound">1</span> of 30 | Score: <span id="nameHandScore">0</span>/30
            </div>
            <div class="card-container" id="nameHandCards"></div>
            <div class="choices-container" id="nameHandChoices"></div>
            <div class="feedback" id="nameHandFeedback"></div>
        </div>

        <!-- Hand vs Hand Game -->
        <div class="game-area" id="handVsHandGame">
            <div class="instructions">
                Which hand wins? Click on the stronger poker hand
            </div>
            <div class="score-display">
                Round <span id="handVsHandRound">1</span> of 10 | Score: <span id="handVsHandScore">0</span>/10
            </div>
            <div class="hand-comparison">
                <div class="hand-side" onclick="selectHand('left')">
                    <h3>Hand A</h3>
                    <div class="card-container" id="leftHandCards"></div>
                    <button class="choice-button" id="leftHandBtn">Select Hand A</button>
                </div>
                <div class="vs-text">VS</div>
                <div class="hand-side" onclick="selectHand('right')">
                    <h3>Hand B</h3>
                    <div class="card-container" id="rightHandCards"></div>
                    <button class="choice-button" id="rightHandBtn">Select Hand B</button>
                </div>
            </div>
            <div class="feedback" id="handVsHandFeedback"></div>
        </div>

        <!-- Best Five Game -->
        <div class="game-area" id="bestFiveGame">
            <div class="instructions">
                Select the 5 cards that make the best poker hand (click cards to select/deselect)
            </div>
            <div class="score-display">
                Round <span id="bestFiveRound">1</span> of 10 | Score: <span id="bestFiveScore">0</span>/10
            </div>
            <div class="seven-card-display">
                <h4>Community Cards (Shared)</h4>
                <div class="community-cards" id="communityCards"></div>
                <div class="divider">───────</div>
                <h4>Your Hole Cards</h4>
                <div class="hole-cards" id="holeCards"></div>
            </div>
            <div class="selected-hand" id="selectedHandDisplay" style="display: none;">
                <h4>Selected Cards (<span id="selectedCount">0</span>/5)</h4>
                <div class="card-container" id="selectedCards"></div>
            </div>
            <button class="submit-button" id="submitBestFive" onclick="submitBestFive()" disabled>
                Submit Hand
            </button>
            <div class="feedback" id="bestFiveFeedback"></div>
        </div>
        </div> <!-- End of game-screen -->

        <!-- Results Modal -->
        <div class="results-modal" id="resultsModal">
            <div class="results-content">
                <h2 id="resultsTitle">Great Job!</h2>
                <div class="score" id="resultsScore">8/10</div>
                <p id="resultsMessage">You've completed this challenge!</p>
                <button class="play-again" onclick="playAgain()">Play Again</button>
                <button class="back-to-menu" onclick="backToMenu()">Back to Menu</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/pokersolver@2.1.4/pokersolver.min.js"></script>
    <script>
        // Game state
        let currentGame = 'nameHand';
        let gameStates = {
            nameHand: {
                round: 0,
                score: 0,
                totalRounds: 30,
                currentHand: null,
                answered: false,
                handTypeOrder: []  // Will be shuffled at start
            },
            handVsHand: {
                round: 0,
                score: 0,
                totalRounds: 10,
                leftHand: null,
                rightHand: null,
                answered: false
            },
            bestFive: {
                round: 0,
                score: 0,
                totalRounds: 10,
                allCards: [],
                selectedIndices: new Set(),
                answered: false
            }
        };

        // High scores tracking
        let highScores = {
            nameHand: 0,
            handVsHand: 0,
            bestFive: 0
        };

        // Load high scores from localStorage
        function loadHighScores() {
            const saved = localStorage.getItem('talkTheTalkHighScores');
            if (saved) {
                highScores = JSON.parse(saved);
                updateHighScoreDisplays();
            }
        }

        // Save high scores to localStorage
        function saveHighScores() {
            localStorage.setItem('talkTheTalkHighScores', JSON.stringify(highScores));
        }

        // Update high score displays on menu
        function updateHighScoreDisplays() {
            document.getElementById('nameHandHighScore').textContent = `Best: ${highScores.nameHand}/30`;
            document.getElementById('bestFiveHighScore').textContent = `Best: ${highScores.bestFive}/10`;
            document.getElementById('handVsHandHighScore').textContent = `Best: ${highScores.handVsHand}/10`;
        }

        // Start a game from menu
        function startGame(game) {
            currentGame = game;
            
            // Hide menu, show game screen
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            
            // Update game title
            const titles = {
                nameHand: 'Name That Hand',
                bestFive: 'Best Five',
                handVsHand: 'Hand vs Hand'
            };
            document.getElementById('currentGameTitle').textContent = titles[game];
            
            // Show/hide game areas
            document.querySelectorAll('.game-area').forEach(area => area.classList.remove('active'));
            document.getElementById(game + 'Game').classList.add('active');
            
            // Start the game
            if (game === 'nameHand') startNameHand();
            else if (game === 'handVsHand') startHandVsHand();
            else if (game === 'bestFive') startBestFive();
        }

        // Return to menu
        function returnToMenu() {
            // Show menu, hide game screen
            document.getElementById('menuScreen').style.display = 'block';
            document.getElementById('gameScreen').style.display = 'none';
            
            // Hide all game areas
            document.querySelectorAll('.game-area').forEach(area => area.classList.remove('active'));
            
            // Update high scores display
            updateHighScoreDisplays();
        }

        // Initialize cards library
        Cards.injectDefaultStyles();
        
        // Mobile detection for card sizing
        const isMobile = window.innerWidth <= 768;
        const cardOptions = {
            width: isMobile ? 60 : 70,
            height: isMobile ? 85 : 100,
            fontSize: isMobile ? 20 : 24
        };

        // Helper to create clickable card for game 3
        function createSelectableCard(card, index) {
            return Cards.createCardElement(card, {
                ...cardOptions,
                clickable: true,
                onClick: () => toggleCardSelection(index),
                selected: state.selectedCards.includes(index)
            });
        }

        // Get hand type name
        function getHandTypeName(hand) {
            const desc = hand.descr.toLowerCase();
            
            if (desc.includes('straight flush')) return 'Straight Flush';
            if (desc.includes('four of a kind')) return 'Four of a Kind';
            if (desc.includes('full house')) return 'Full House';
            if (desc.includes('flush')) return 'Flush';
            if (desc.includes('straight')) return 'Straight';
            if (desc.includes('three of a kind')) return 'Three of a Kind';
            if (desc.includes('two pair')) return 'Two Pair';
            if (desc.includes('pair')) return 'Pair';
            return 'High Card';
        }

        // Hand ranking order
        const handRankings = [
            'High Card',
            'Pair',
            'Two Pair',
            'Three of a Kind',
            'Straight',
            'Flush',
            'Full House',
            'Four of a Kind',
            'Straight Flush'
        ];

        // Generate a specific hand type for variety
        function generateSpecificHandType(targetType, randomFunc) {
            const ranks = ['2', '3', '4', '5', '6', '7', '8', '9', 'T', 'J', 'Q', 'K', 'A'];
            const suits = ['h', 'd', 'c', 's'];
            
            // Helper to create a card
            const makeCard = (rank, suit) => rank + suit;
            
            // Helper to shuffle using provided random function
            const shuffle = (arr) => {
                const result = [...arr];
                for (let i = result.length - 1; i > 0; i--) {
                    const j = Math.floor((typeof randomFunc === 'function' ? randomFunc() : Math.random()) * (i + 1));
                    [result[i], result[j]] = [result[j], result[i]];
                }
                return result;
            };
            
            // Shuffle for randomness within type
            const shuffledRanks = shuffle(ranks);
            const shuffledSuits = shuffle(suits);
            
            // Use random function or Math.random
            const random = typeof randomFunc === 'function' ? randomFunc : Math.random;
            
            let hand = [];
            
            switch(targetType) {
                case 'Straight Flush':
                    // Create a straight flush
                    const sfStart = Math.floor(random() * 9); // Can start from 0-8 (A-9)
                    const sfSuit = shuffledSuits[0];
                    for (let i = 0; i < 5; i++) {
                        hand.push(makeCard(ranks[sfStart + i], sfSuit));
                    }
                    break;
                    
                case 'Four of a Kind':
                    // Four of same rank + one other
                    const fourRank = shuffledRanks[0];
                    const kickerRank = shuffledRanks[1];
                    suits.forEach(s => hand.push(makeCard(fourRank, s)));
                    hand.push(makeCard(kickerRank, shuffledSuits[0]));
                    break;
                    
                case 'Full House':
                    // Three of one rank, two of another
                    const threeRank = shuffledRanks[0];
                    const pairRank = shuffledRanks[1];
                    hand.push(makeCard(threeRank, suits[0]));
                    hand.push(makeCard(threeRank, suits[1]));
                    hand.push(makeCard(threeRank, suits[2]));
                    hand.push(makeCard(pairRank, suits[0]));
                    hand.push(makeCard(pairRank, suits[1]));
                    break;
                    
                case 'Flush':
                    // Five cards of same suit, not in sequence
                    const flushSuit = shuffledSuits[0];
                    // Pick 5 non-sequential ranks
                    const nonSeq = [0, 2, 4, 7, 11]; // Guaranteed non-sequential
                    nonSeq.forEach(i => hand.push(makeCard(shuffledRanks[i], flushSuit)));
                    break;
                    
                case 'Straight':
                    // Five sequential ranks, different suits
                    const straightStart = Math.floor(random() * 10); // Can start from 0-9
                    for (let i = 0; i < 5; i++) {
                        hand.push(makeCard(ranks[straightStart + i], shuffledSuits[i % 4]));
                    }
                    // Make sure it's not a flush
                    hand[4] = makeCard(ranks[straightStart + 4], shuffledSuits[(shuffledSuits.indexOf(hand[0][1]) + 1) % 4]);
                    break;
                    
                case 'Three of a Kind':
                    // Three of same rank + two different
                    const tripRank = shuffledRanks[0];
                    hand.push(makeCard(tripRank, suits[0]));
                    hand.push(makeCard(tripRank, suits[1]));
                    hand.push(makeCard(tripRank, suits[2]));
                    hand.push(makeCard(shuffledRanks[1], shuffledSuits[0]));
                    hand.push(makeCard(shuffledRanks[2], shuffledSuits[1]));
                    break;
                    
                case 'Two Pair':
                    // Two of one rank, two of another, one different
                    const pair1Rank = shuffledRanks[0];
                    const pair2Rank = shuffledRanks[1];
                    const kicker = shuffledRanks[2];
                    hand.push(makeCard(pair1Rank, suits[0]));
                    hand.push(makeCard(pair1Rank, suits[1]));
                    hand.push(makeCard(pair2Rank, suits[2]));
                    hand.push(makeCard(pair2Rank, suits[3]));
                    hand.push(makeCard(kicker, shuffledSuits[0]));
                    break;
                    
                case 'Pair':
                    // Two of same rank + three different
                    const pairOnlyRank = shuffledRanks[0];
                    hand.push(makeCard(pairOnlyRank, suits[0]));
                    hand.push(makeCard(pairOnlyRank, suits[1]));
                    hand.push(makeCard(shuffledRanks[1], shuffledSuits[0]));
                    hand.push(makeCard(shuffledRanks[2], shuffledSuits[1]));
                    hand.push(makeCard(shuffledRanks[3], shuffledSuits[2]));
                    break;
                    
                default: // High Card
                    // Five different ranks, not in sequence, not same suit
                    const highCardRanks = [0, 2, 4, 6, 9]; // Non-sequential indices
                    highCardRanks.forEach((rankIdx, i) => {
                        hand.push(makeCard(shuffledRanks[rankIdx], suits[i % 4]));
                    });
                    break;
            }
            
            // Shuffle the hand to randomize card order
            return shuffle(hand);
        }

        // NAME THAT HAND GAME
        function startNameHand() {
            const state = gameStates.nameHand;
            state.round = 0;
            state.score = 0;
            
            // Create an even distribution of hand types for 30 rounds
            // 9 hand types, so roughly 3-4 of each type
            const handTypes = [];
            
            // Add 3 of each type (27 total)
            for (let i = 0; i < 3; i++) {
                handTypes.push('High Card', 'Pair', 'Two Pair', 'Three of a Kind', 
                              'Straight', 'Flush', 'Full House', 'Four of a Kind', 'Straight Flush');
            }
            
            // Add 3 more of the common types to reach 30
            handTypes.push('Pair', 'Two Pair', 'Flush');
            
            // Shuffle the array for random order
            for (let i = handTypes.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [handTypes[i], handTypes[j]] = [handTypes[j], handTypes[i]];
            }
            
            state.handTypeOrder = handTypes;
            nextNameHand();
        }

        function nextNameHand() {
            const state = gameStates.nameHand;
            
            if (state.round >= state.totalRounds) {
                endGame('nameHand');
                return;
            }
            
            state.round++;
            state.answered = false;
            
            // Update display
            document.getElementById('nameHandRound').textContent = state.round;
            document.getElementById('nameHandScore').textContent = state.score;
            
            // Get the target hand type for this round
            const targetType = state.handTypeOrder[state.round - 1];
            
            // Generate a hand of that type using normal random
            const hand = generateSpecificHandType(targetType, Math.random);
            
            try {
                state.currentHand = Hand.solve(hand);
            } catch (error) {
                console.error('Error solving hand:', error, 'Cards:', hand);
                alert('Error generating hand. Please refresh the page.');
                return;
            }
            
            // Display cards
            const container = document.getElementById('nameHandCards');
            container.innerHTML = '';
            hand.forEach(card => {
                container.appendChild(Cards.createCardElement(card, cardOptions));
            });
            
            // Create choices
            const correctAnswer = getHandTypeName(state.currentHand);
            const choices = [...handRankings]; // Already in order from low to high
            
            // Display choices in rank order (no shuffling)
            const choicesContainer = document.getElementById('nameHandChoices');
            choicesContainer.innerHTML = '';
            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'choice-button';
                btn.textContent = choice;
                btn.onclick = () => checkNameHandAnswer(choice);
                choicesContainer.appendChild(btn);
            });
            
            // Hide feedback
            document.getElementById('nameHandFeedback').classList.remove('show');
        }

        function checkNameHandAnswer(answer) {
            const state = gameStates.nameHand;
            if (state.answered) return;
            
            state.answered = true;
            const correct = getHandTypeName(state.currentHand);
            const isCorrect = answer === correct;
            
            if (isCorrect) {
                state.score++;
            }
            
            // Update buttons
            const buttons = document.querySelectorAll('#nameHandChoices .choice-button');
            buttons.forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === correct) {
                    btn.classList.add('correct');
                } else if (btn.textContent === answer && !isCorrect) {
                    btn.classList.add('incorrect');
                }
            });
            
            // Show feedback
            const feedback = document.getElementById('nameHandFeedback');
            feedback.className = 'feedback show ' + (isCorrect ? 'correct' : 'incorrect');
            
            if (isCorrect) {
                feedback.innerHTML = '✓ Correct! This is indeed a ' + correct;
                // Auto-advance after a short delay
                setTimeout(() => {
                    nextNameHand();
                }, 1500);
            } else {
                feedback.innerHTML = '✗ Not quite. This hand is a ' + correct + '. ' + state.currentHand.descr + 
                                    '<br><br><strong>Click anywhere to continue</strong>';
                // Wait for click to continue
                feedback.style.cursor = 'pointer';
                feedback.onclick = () => {
                    feedback.onclick = null;
                    feedback.style.cursor = 'default';
                    nextNameHand();
                };
            }
        }

        // HAND VS HAND GAME
        function startHandVsHand() {
            const state = gameStates.handVsHand;
            state.round = 0;
            state.score = 0;
            nextHandVsHand();
        }

        function nextHandVsHand() {
            const state = gameStates.handVsHand;
            
            if (state.round >= state.totalRounds) {
                endGame('handVsHand');
                return;
            }
            
            state.round++;
            state.answered = false;
            
            // Update display
            document.getElementById('handVsHandRound').textContent = state.round;
            document.getElementById('handVsHandScore').textContent = state.score;
            
            // Generate two different hands using regular random
            const deck = Cards.generateDeck({ shuffled: true });
            const leftCards = deck.slice(0, 5);
            const rightCards = deck.slice(5, 10);
            
            state.leftHand = Hand.solve(leftCards);
            state.rightHand = Hand.solve(rightCards);
            
            // Display left hand
            const leftContainer = document.getElementById('leftHandCards');
            leftContainer.innerHTML = '';
            leftCards.forEach(card => {
                leftContainer.appendChild(Cards.createCardElement(card, cardOptions));
            });
            
            // Display right hand
            const rightContainer = document.getElementById('rightHandCards');
            rightContainer.innerHTML = '';
            rightCards.forEach(card => {
                rightContainer.appendChild(Cards.createCardElement(card, cardOptions));
            });
            
            // Reset buttons
            document.getElementById('leftHandBtn').className = 'choice-button';
            document.getElementById('leftHandBtn').disabled = false;
            document.getElementById('rightHandBtn').className = 'choice-button';
            document.getElementById('rightHandBtn').disabled = false;
            
            // Hide feedback
            document.getElementById('handVsHandFeedback').classList.remove('show');
        }

        function selectHand(side) {
            const state = gameStates.handVsHand;
            if (state.answered) return;
            
            state.answered = true;
            
            // Determine winner
            const winners = Hand.winners([state.leftHand, state.rightHand]);
            const leftWins = winners.includes(state.leftHand);
            const rightWins = winners.includes(state.rightHand);
            const tie = leftWins && rightWins;
            
            const isCorrect = (side === 'left' && leftWins && !tie) || 
                              (side === 'right' && rightWins && !tie);
            
            if (isCorrect || tie) {
                state.score++;
            }
            
            // Update buttons
            const leftBtn = document.getElementById('leftHandBtn');
            const rightBtn = document.getElementById('rightHandBtn');
            
            leftBtn.disabled = true;
            rightBtn.disabled = true;
            
            if (leftWins && !tie) {
                leftBtn.classList.add('correct');
                if (side === 'right') rightBtn.classList.add('incorrect');
            } else if (rightWins && !tie) {
                rightBtn.classList.add('correct');
                if (side === 'left') leftBtn.classList.add('incorrect');
            } else if (tie) {
                leftBtn.classList.add('correct');
                rightBtn.classList.add('correct');
            }
            
            // Show feedback
            const feedback = document.getElementById('handVsHandFeedback');
            let message = '';
            
            if (tie) {
                message = '✓ It\'s a tie! Both hands are equal: ' + state.leftHand.descr;
            } else if (isCorrect) {
                const winner = side === 'left' ? state.leftHand : state.rightHand;
                message = '✓ Correct! ' + winner.descr + ' beats the other hand';
            } else {
                const winner = leftWins ? state.leftHand : state.rightHand;
                message = '✗ Not quite. ' + winner.descr + ' is the stronger hand';
            }
            
            feedback.className = 'feedback show ' + (isCorrect || tie ? 'correct' : 'incorrect');
            feedback.innerHTML = message + '<br><br>Hand A: ' + state.leftHand.descr + 
                                '<br>Hand B: ' + state.rightHand.descr;
            
            if (isCorrect || tie) {
                // Auto-advance after a short delay
                setTimeout(() => {
                    nextHandVsHand();
                }, 2000);
            } else {
                feedback.innerHTML += '<br><br><strong>Click anywhere to continue</strong>';
                // Wait for click to continue
                feedback.style.cursor = 'pointer';
                feedback.onclick = () => {
                    feedback.onclick = null;
                    feedback.style.cursor = 'default';
                    nextHandVsHand();
                };
            }
        }

        // BEST FIVE GAME
        function startBestFive() {
            const state = gameStates.bestFive;
            state.round = 0;
            state.score = 0;
            nextBestFive();
        }

        function nextBestFive() {
            const state = gameStates.bestFive;
            
            if (state.round >= state.totalRounds) {
                endGame('bestFive');
                return;
            }
            
            state.round++;
            state.answered = false;
            state.selectedIndices.clear();
            
            // Update display
            document.getElementById('bestFiveRound').textContent = state.round;
            document.getElementById('bestFiveScore').textContent = state.score;
            
            // Generate 7 cards (5 community + 2 hole) using regular random
            const deck = Cards.generateDeck({ shuffled: true });
            state.allCards = deck.slice(0, 7);
            
            // Display community cards
            const communityContainer = document.getElementById('communityCards');
            communityContainer.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const cardEl = createSelectableCard(state.allCards[i], i);
                communityContainer.appendChild(cardEl);
            }
            
            // Display hole cards
            const holeContainer = document.getElementById('holeCards');
            holeContainer.innerHTML = '';
            for (let i = 5; i < 7; i++) {
                const cardEl = createSelectableCard(state.allCards[i], i);
                holeContainer.appendChild(cardEl);
            }
            
            // Reset display
            document.getElementById('selectedHandDisplay').style.display = 'none';
            document.getElementById('submitBestFive').disabled = true;
            document.getElementById('bestFiveFeedback').classList.remove('show');
        }

        function toggleCardSelection(index) {
            const state = gameStates.bestFive;
            if (state.answered) return;
            
            if (state.selectedIndices.has(index)) {
                state.selectedIndices.delete(index);
            } else if (state.selectedIndices.size < 5) {
                state.selectedIndices.add(index);
            } else {
                return; // Already have 5 selected
            }
            
            // Update visual selection
            const allCards = document.querySelectorAll('#communityCards .card, #holeCards .card');
            allCards.forEach((card, i) => {
                if (state.selectedIndices.has(i)) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
            
            // Update selected hand display
            if (state.selectedIndices.size > 0) {
                document.getElementById('selectedHandDisplay').style.display = 'block';
                document.getElementById('selectedCount').textContent = state.selectedIndices.size;
                
                const selectedContainer = document.getElementById('selectedCards');
                selectedContainer.innerHTML = '';
                [...state.selectedIndices].sort().forEach(idx => {
                    selectedContainer.appendChild(Cards.createCardElement(state.allCards[idx], cardOptions));
                });
            } else {
                document.getElementById('selectedHandDisplay').style.display = 'none';
            }
            
            // Enable/disable submit button
            document.getElementById('submitBestFive').disabled = state.selectedIndices.size !== 5;
        }

        function submitBestFive() {
            const state = gameStates.bestFive;
            if (state.answered || state.selectedIndices.size !== 5) return;
            
            state.answered = true;
            
            // Get selected cards
            const selectedCards = [...state.selectedIndices].map(i => state.allCards[i]);
            const selectedHand = Hand.solve(selectedCards);
            
            // Find best possible hand
            let bestHand = null;
            let bestCards = [];
            
            // Try all combinations of 5 cards from 7
            for (let i = 0; i < 7; i++) {
                for (let j = i + 1; j < 7; j++) {
                    // Skip these two cards, use the other 5
                    const fiveCards = state.allCards.filter((_, idx) => idx !== i && idx !== j);
                    const hand = Hand.solve(fiveCards);
                    
                    if (!bestHand || Hand.winners([hand, bestHand])[0] === hand) {
                        bestHand = hand;
                        bestCards = fiveCards;
                    }
                }
            }
            
            // Check if correct
            const isCorrect = Hand.winners([selectedHand, bestHand]).includes(selectedHand);
            
            if (isCorrect) {
                state.score++;
            }
            
            // Show feedback
            const feedback = document.getElementById('bestFiveFeedback');
            feedback.className = 'feedback show ' + (isCorrect ? 'correct' : 'incorrect');
            
            if (isCorrect) {
                feedback.innerHTML = '✓ Perfect! You found the best hand: ' + selectedHand.descr;
                // Auto-advance after a short delay
                setTimeout(() => {
                    nextBestFive();
                }, 2000);
            } else {
                feedback.innerHTML = '✗ Not quite. Your hand: ' + selectedHand.descr + 
                                   '<br>Best possible: ' + bestHand.descr + 
                                   '<br>Best cards: ' + bestCards.join(' ') +
                                   '<br><br><strong>Click anywhere to continue</strong>';
                // Wait for click to continue
                feedback.style.cursor = 'pointer';
                feedback.onclick = () => {
                    feedback.onclick = null;
                    feedback.style.cursor = 'default';
                    nextBestFive();
                };
            }
            
            // Disable submit button
            document.getElementById('submitBestFive').disabled = true;
        }

        // End game and show results
        function endGame(game) {
            const state = gameStates[game];
            const score = state.score;
            const total = state.totalRounds;
            
            // Update high score if this is better
            if (score > highScores[game]) {
                highScores[game] = score;
                saveHighScores();
                updateHighScoreDisplays();
            }
            
            // Show results modal
            const modal = document.getElementById('resultsModal');
            const title = document.getElementById('resultsTitle');
            const scoreDisplay = document.getElementById('resultsScore');
            const message = document.getElementById('resultsMessage');
            
            scoreDisplay.textContent = score + '/' + total;
            
            // Different thresholds for 30-round Name That Hand vs 10-round other games
            const excellentThreshold = game === 'nameHand' ? 24 : 8;
            const goodThreshold = game === 'nameHand' ? 18 : 6;
            
            if (score >= excellentThreshold) {
                title.textContent = 'Excellent!';
                message.textContent = 'You\'ve mastered this challenge!';
                
                if (game === 'bestFive' && score >= 8) {
                    message.textContent += ' You\'re ready for The Nuts challenge!';
                }
            } else if (score >= goodThreshold) {
                title.textContent = 'Good Job!';
                message.textContent = 'Keep practicing to improve your score!';
            } else {
                title.textContent = 'Keep Practicing!';
                message.textContent = 'You\'ll get better with practice. Try again!';
            }
            
            modal.classList.add('show');
        }

        function playAgain() {
            document.getElementById('resultsModal').classList.remove('show');
            if (currentGame === 'nameHand') startNameHand();
            else if (currentGame === 'handVsHand') startHandVsHand();
            else if (currentGame === 'bestFive') startBestFive();
        }

        function backToMenu() {
            document.getElementById('resultsModal').classList.remove('show');
            returnToMenu();
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', function() {
            // Check if pokersolver loaded
            if (typeof Hand === 'undefined') {
                console.error('Pokersolver library not loaded!');
                alert('Error: Poker library failed to load. Please refresh the page.');
                return;
            }
            
            // Load high scores and show menu
            loadHighScores();
        });
    </script>
</body>
</html>